# Tsunami

This project extends Tsunami network scanner to run on a given list of IPs over AWS infrastructure.

Tsunami is a general purpose network security scanner with an extensible plugin
system for detecting high severity vulnerabilities with high confidence.

Tsunami network scanner's code (0.0.12) was taken from
[git](https://github.com/google/tsunami-security-scanner/blob/master/docs/index.md).

## Explanation

Tsunami's CLI allows the user to run only on a single target server at once.
In this project I copied the Dockerfile and added an entrypoint.sh to allow reading a list of servers
and run the scanner on each one of them. The logs are written to a local filesystem.

I run the container over ECS cluster, using an EFS as the output path for the scanner's results.
A lambda runs over the results (EFS mounted) and prints whether vulnerabilities were found in those.

## Current Status

*   Official Tsunami is in 'pre-alpha' release for developer preview.
*   Tsunami project is currently under active development.
*   Tsunami's files used are from version 0.0.12

## AWS Resources

This project creates resources in AWS:

*   VPC
*   EFS
*   ECS Cluster
*   Lambda Function
*   IAM roles & policies

## How to run this deployment

### Prerequisites
 1.  (Optional) Create a 'vulnerable' EC2.
     Don't forget to open ports 22 & 8888 in it security group.

     ```
     sudo apt update
     sudo apt install docker.io -y
     sudo docker run --name unauthenticated-jupyter-notebook -p 8888:8888 -d jupyter/base-notebook start-notebook.sh --NotebookApp.token=''
     ```

 2.  Create a S3 bucket in your target region and copy there a list of servers to scan:

     ```
     aws s3 cp ./example_servers.txt s3://<bucket>/servers.txt
     ```

 3.  Create an ECR in your target region and upload the image:

     ```
     docker build -t <account>.dkr.ecr.<region>.amazonaws.com/tsunami:latest .
     aws ecr get-login-password --region <region> | docker login --username AWS --password-stdin <account>.dkr.ecr.<region>.amazonaws.com
     docker push <account>.dkr.ecr.<region>.amazonaws.com/tsunami:latest
     ```

### Deploy resources
 1.  Deploy the resources using `terraform`.
     Insert your variables;
     *   aws_region - the target region (us-east-1, eu-west-2 etc).
     *   s3_uri - the full URI of the servers' file. Use the format "s3://<bucket>/<file.txt>".
     *   repo_name - the name of the repository where you put the already-built image (only the name of the repository).

     ```
     cd terraform
     terraform apply -var-file=default.tfvars -var 'aws_region=eu-west-1' -var 's3_uri=<uri>' -var 'ecr_name=<repo_name>'
     ```

 After the ECS' task runs, go to the Lambda and run it.
 You can see in the output/CloudWatch whether vulnerabilities have been found in the last run.

### EFS files
 1.  In order to see the EFS files generated by the scanner, deploy an EC2 in the az and mount the EFS.
     SSH to the instance.
     
 2.  Mount the EFS using the commands from the browser.
     Use this
     [blog](https://medium.com/geekculture/ow-to-setup-amazon-elastic-file-system-efs-and-mount-on-to-ubuntu-ec2-b47346427d5)
     to be able to nfs mount.

## License

Tsunami is released under the [Apache 2.0 license](LICENSE).

```
Copyright 2019 Google Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
```

## Disclaimers

Tsunami is not an official Google product.

Tsunami's files are taken from the git repo!
I edited the Dockerfile & entrypoint.sh.

## Next versions / TODOs

 1.  Change ECS' tasks to be scheduled tasks.
 2.  Better view over the EFS file system instead of a mount over EC2.
 3.  Invoke the lambda after the task finishes scanning the servers.
 4.  Add SNS / notification alert when the lambda finishes.
 5.  Split terraform to modules & extend user's intervention of the variables.
